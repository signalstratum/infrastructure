name: Terraform

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Manual trigger for testing

permissions:
  contents: read
  pull-requests: write

env:
  TF_VERSION: "1.14.3"
  TF_WORKING_DIR: "terraform"

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    # Skip fork PRs - they cannot access secrets and should not run workflows
    if: github.event.pull_request.head.repo.fork != true
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3.1.0
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_INFRA_SA }}
          # Provider authentication
          GITHUB_TOKEN: op://ss-infrastructure/github/api-token
          CLOUDFLARE_API_TOKEN: op://ss-infrastructure/cloudflare/api-token
          # R2 Backend (S3-compatible)
          AWS_ACCESS_KEY_ID: op://ss-infrastructure/r2/access-key-id
          AWS_SECRET_ACCESS_KEY: op://ss-infrastructure/r2/secret-access-key
          AWS_ENDPOINT_URL_S3: op://ss-infrastructure/r2/url
          # GitHub App - Cloudflare Zero Trust OAuth
          TF_VAR_github_app_client_id: op://ss-infrastructure/github/github-app-client-id
          TF_VAR_github_app_client_secret: op://ss-infrastructure/github/github-app-client-secret
          # GitHub App - ARC (Actions Runner Controller)
          TF_VAR_github_app_id: op://ss-infrastructure/github/github-app-id
          TF_VAR_github_app_installation_id: op://ss-infrastructure/github/github-app-installation-id
          TF_VAR_github_app_private_key: op://ss-infrastructure/github/github-app-private-key

      - name: Inject tfvars from 1Password
        run: op inject -i terraform.tfvars.tpl -o terraform.tfvars
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_INFRA_SA }}

      - name: Set 1Password provider config
        run: |
          echo "OP_SERVICE_ACCOUNT_TOKEN=${{ secrets.OP_TF_SA }}" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6.2.1
        with:
          tflint_version: latest

      - name: Init TFLint
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Run TFLint
        id: tflint
        run: tflint --format compact
        continue-on-error: true

      - name: Run Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@02a4c5d6a02367e5ea493c34c26b094302fd3f61 # v12.3075.0
        with:
          directory: .
          framework: terraform
          quiet: true
          soft_fail: true
          output_format: cli
          download_external_modules: false

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        if: github.event_name == 'pull_request'
        with:
          script: |
            const output = `#### Terraform Format ğŸ–Œ \`${{ steps.fmt.outcome }}\`
            #### TFLint ğŸ” \`${{ steps.tflint.outcome }}\`
            #### Checkov Security ğŸ›¡ï¸ \`${{ steps.checkov.outcome }}\`
            #### Terraform Init âš™ï¸ \`${{ steps.init.outcome }}\`
            #### Terraform Validate ğŸ¤– \`${{ steps.validate.outcome }}\`
            #### Terraform Plan ğŸ“– \`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve tfplan
